<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Home</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <style>
        .query {
            border: 1px solid #000;
            width: 300px;
            margin: 10px;
            padding: 10px;
            display: inline-block;
            word-wrap: break-word;
        }
    </style>
</head>
<body>

    <br>

    <!-- Registration -->
    <form style="width:500px" class="query" id="registration" method="POST" action="http://localhost:1212/register">
        <label>Username</label> <input name="username" type="text" value="" />
        <label>Password</label> <input name="password" type="password" value="" />
        <input type="submit" value="Register" />
    </form>

    <br>

    <!-- Login -->
    <form style="width:500px" class="query" id="login" method="POST" action="http://localhost:1212/login">
        <label>Username</label><input name="username" type="text" value="" />
        <label>Password</label><input name="password" type="password" value="" />
        <input type="submit" value="Login" />
    </form>

    <br>

    <!-- Token -->
    <div class="query" id="token">Your token: </div>

    <br>

    <textarea class="query" id="messagebox" cols="30" rows="10" placeholder="Type a message"></textarea>

    <br>
    <br>

     <!-- Send friend request -->
     <div class="query">
        <label>Send friend request:</label> <br>
        <input id="friend-request" type="text" placeholder="User ID"/>
        <button onclick="sendFriendRequest()">Send Request</button>
    </div>

    <br>

    <!-- Your friends -->
    <div class="query">
        <label>Your Friends:</label> <br>
        <div id="your-friends"></div>
    </div>

    <!-- TODO: Your friend requests -->

    <br>

    <!-- Find users -->
    <div class="query">
        <!-- Input -->
        <label>Find Users:</label> <br>
        <input id="find-users" type="text" value="" placeholder="Username"/> <br>
        <!-- Results -->
        <label>Results:</label> <br>
        <div id="user-matches"></div>
    </div>

    <br>
    

    <!-- Your hubs -->
    <div class="query">
        <label>Your Hubs:</label> <br>
        <div id="your-hubs"></div>
    </div>

    <br>

    <!-- Create hubs -->
    <div class="query">
        <form id="create-hub" method="POST" action="http://localhost:1212/create-hub">
            <label>Create a new Hub:</label> <br>
            <input id="create-hub" name="hub_id" type="text" value="" placeholder="Hub Name"/> <button type="submit">Create</button>
        </form>
    </div>

    <br>

    <!-- Find hubs -->
    <div class="query">
        <!-- Input -->
        <label>Find Hubs:</label> <br>
        <input id="find-hubs" type="text" value="" placeholder="Hub Name"/> <br>
        <!-- Results -->
        <label>Results:</label> <br>
        <div id="hub-matches"></div>
    </div>

    <br>

    <!-- Join a hub -->
    <div class="query">
        <label>Join a Hub:</label> <br>
        <input id="hubid" type="text" placeholder="Hub ID"/>
        <button onclick="beginWebsocket()">Join</button>
    </div>

    <br>

    <br>


    <script type="text/javascript">

        // user info
        var token;
        var email;
        var uuid;

        // web sockets
        var ws = null;
        var hubSearchWS = null;
        var userSearchWS = null

        // form handlers
        $("#create-hub").submit(function(e) {
            var form = $(this);
            var url = form.attr('action') + "?token=" + token;
            e.stopPropagation();
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: url,
                data: form.serialize(),
                success: function(data, textStatus, xhr) {
                    if (xhr.status != 200) {
                        console.log(data.responseText);
                    } else {
                        console.log("hub successfully created");
                        js = JSON.parse(data);
                        console.log(js);

                        loadYourHubs();
                    }
                },
                error: function(data, textStatus, xhr) {
                    console.log(data.responseText);
                }
            });
            return false;
        });

        $("#registration").submit(function(e) {
            var form = $(this);
            var url = form.attr('action');
            e.stopPropagation();
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: url,
                data: form.serialize(),
                success: function(data, textStatus, xhr) {
                    if (xhr.status != 200) {
                        console.log(data.responseText);
                    } else {
                        
                        js = JSON.parse(data);
                        console.log(js);
                    }
                },
                error: function(data, textStatus, xhr) {
                    console.log(data.responseText);
                }
            });
            return false;
        });

        $("#login").submit(function(e) {
            var form = $(this);
            var url = form.attr('action');
            e.stopPropagation();
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: url,
                data: form.serialize(),
                success: function(data, textStatus, xhr) {
                    if (xhr.status != 200) {
                        console.log(data.responseText);
                    } else {
                        console.log(data);
                        email = data.email;
                        token = data.token;
                        uuid = data.uuid;
                        $("#token").append(token);

                        loadYourHubs();
                        loadYourFriends();
                    }
                },
                error: function(data, textStatus, xhr) {
                    console.log(data.responseText);
                }
            });
            return false;
        });


        // web socket connections
        function beginWebsocket() {

            if (ws != null) ws.close();

            var hubID = $('#hubid').val();

            ws = new WebSocket("ws://localhost:1212/ws?token="+token+"&hub="+hubID);
            waitForSocketConnection(ws, function() {
                console.log("Connected.");

                ws.onmessage = function (evt) {

                    var messages = evt.data.split('\n');
                    if (messages.length > 0) {
                        var msg = JSON.parse(messages[0]);
                        console.log(msg);
                        // console.log(msg.email + ": " + msg.Message);
                    } else {
                        console.log("error parsing message!");
                    }
                };

            });
        }

        function connectUserSearchWebsocket() {

            userSearchWS = new WebSocket("ws://localhost:1212/ws/find-users");
            waitForSocketConnection(userSearchWS, function() {
                console.log("Connected to user search websocket.");
                userSearchWS.onmessage = function (evt) {

                    var results = evt.data.split('\n');

                    if (results.length > 0) {

                        results = JSON.parse(results[0]);

                        console.log(results);
                        $("#user-matches").empty();

                        for (var r in results) {
                            var match = document.createElement('div');
                            match.className = "user-match";
                            var user = results[r]
                            match.innerHTML = user.Username + ": " + user.ID;
                            $("#user-matches").append(match);
                        }

                    } else {
                        console.log("error parsing message!");
                    }
                };
            });

        }

        function connectHubSearchWebsocket() {

            hubSearchWS = new WebSocket("ws://localhost:1212/ws/find-hubs");
            waitForSocketConnection(hubSearchWS, function() {
                console.log("Connected to hub search websocket.");
                hubSearchWS.onmessage = function (evt) {

                    var results = evt.data.split('\n');

                    if (results.length > 0) {

                        results = JSON.parse(results[0]);

                        console.log(results);
                        $("#hub-matches").empty();

                        for (var r in results) {
                            var match = document.createElement('div');
                            match.className = "hub-match";
                            match.innerHTML = results[r].ID;
                            $("#hub-matches").append(match);
                        }

                    } else {
                        console.log("error parsing message!");
                    }
                };
            });

        }


        // websocket handlers
        $("#find-hubs").keydown(function(e) {

            if (hubSearchWS == null || hubSearchWS.readyState != hubSearchWS.OPEN) {
                console.log('you are not connected.');
                connectHubSearchWebsocket();
            }

            waitForSocketConnection(hubSearchWS, function() {
                hubSearchWS.send($("#find-hubs").val());
            });

        })

        $("#find-users").keydown(function(e) {

            if (userSearchWS == null || userSearchWS.readyState != userSearchWS.OPEN) {
                console.log('you are not connected.');
                connectUserSearchWebsocket();
            }

            waitForSocketConnection(userSearchWS, function() {
                userSearchWS.send($("#find-users").val());
            });

        })

        function sendFriendRequest() {

            var url = "http://localhost:1212/send-friend-request?token="+token;
            $.ajax({
                type: 'POST',
                url: url,
                data: {
                    token: token,
                    user_id: $("#friend-request").val()
                },
                success: function(data, textStatus, xhr) {
                    if (xhr.status != 200) {
                        console.log(data.responseText);
                    } else {
                        // js = JSON.parse(data);
                        console.log(textStatus);
                    }
                },
                error: function(data, textStatus, xhr) {
                    console.log(data.responseText);
                }
            });
            
        }

        function loadYourHubs() {

            $("#your-hubs").empty();

            $.ajax({
                type: 'GET',
                url: "http://localhost:1212/my-hubs?token="+token,
                success: function(data, textStatus, xhr) {
                    if (xhr.status != 200) {
                        console.log(data.responseText);
                    } else {
                        data = JSON.parse(data);

                        for (var d in data) {
                            var hub = document.createElement('div');
                            hub.className = "hub";
                            hub.innerHTML = data[d].ID;
                            $("#your-hubs").append(hub);
                        }
                    }
                },
                error: function(data, textStatus, xhr) {
                    console.log(data.responseText);
                }
            });

        }

        function loadYourFriends() {

            $("#your-friends").empty();

            $.ajax({
                type: 'GET',
                url: "http://localhost:1212/my-friends?token="+token,
                success: function(data, textStatus, xhr) {
                    if (xhr.status != 200) {
                        console.log(data.responseText);
                    } else {
                        data = JSON.parse(data);

                        console.log(data);

                        for (var d in data) {
                            var friend = document.createElement('div');
                            friend.className = "friend";
                            friend.innerHTML = data[d].Username + ": " + data[d].ID;
                            $("#your-friends").append(friend);
                        }
                    }
                },
                error: function(data, textStatus, xhr) {
                    console.log(data.responseText);
                }
            });

        }

        $("#messagebox").keypress(function(e){
            if (e.keyCode == 13) {
                e.preventDefault();
                sendMessage($(this).val());
                $(this).val("");
            }
        });

        function sendMessage(msg){

            if (ws == null) {
                console.log('you are not connected.');
                return;
            }

            waitForSocketConnection(ws, function() {
                ws.send(JSON.stringify({
                    sender: uuid,
                    message: msg
                }));
            });

        }

        // Make the function wait until the connection is made...
        function waitForSocketConnection(socket, callback){
            setTimeout(function () {
                    if (socket.readyState === 1) {
                        if(callback != null) {
                            callback();
                        }
                        return;
                    } else {
                        console.log("Waiting to connect.");
                        waitForSocketConnection(socket, callback);
                    }
                },
            5); // wait 5 miliseconds
        }

    </script>
    
    
</body>
</html>
